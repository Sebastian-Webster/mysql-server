#
# Bug#37235041 - Duplicate Detection Flaw for NULL Values in UK During
# DDL Rollback Operations
#
CREATE TABLE t1 (id int primary key, c1 int,c2 int);
INSERT INTO t1 VALUES (1,1,null);
INSERT INTO t1 VALUES (2,2,null);
SET DEBUG_SYNC = 'row_log_apply_before SIGNAL s1 WAIT_FOR s2';
SET DEBUG_SYNC = 'row_log_apply_after  WAIT_FOR s3';
ALTER TABLE t1 ADD UNIQUE KEY uk1(c1,c2);
SET DEBUG_SYNC = 'now WAIT_FOR s1';
BEGIN;
DELETE FROM t1 where id=1;
SET DEBUG_SYNC = 'now SIGNAL s2';
INSERT INTO t1 VALUES (3,1,null);
ROLLBACK;
SET DEBUG_SYNC = 'now SIGNAL s3';
select id,c1,c2 from t1 force index(primary);
id	c1	c2
1	1	NULL
2	2	NULL
3	1	NULL
select id,c1,c2 from t1 force index(uk1);
id	c1	c2
1	1	NULL
3	1	NULL
2	2	NULL
DROP TABLE t1;
CREATE TABLE t1 (id int primary key, c1 int);
INSERT INTO t1 VALUES (1,1);
SET DEBUG_SYNC = 'row_log_apply_before SIGNAL s1 WAIT_FOR s2';
SET DEBUG_SYNC = 'row_log_apply_after  WAIT_FOR s3';
ALTER TABLE t1 ADD UNIQUE KEY uk2(c1);
SET DEBUG_SYNC = 'now WAIT_FOR s1';
BEGIN;
DELETE FROM t1 where id=1;
SET DEBUG_SYNC = 'now SIGNAL s2';
INSERT INTO t1 VALUES (2,1);
ROLLBACK;
SET DEBUG_SYNC = 'now SIGNAL s3';
ERROR 23000: Duplicate entry for key 'uk2'
CHECK TABLE t1;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int NOT NULL,
  `c1` int DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT * FROM t1;
id	c1
1	1
2	1
DROP TABLE t1;
