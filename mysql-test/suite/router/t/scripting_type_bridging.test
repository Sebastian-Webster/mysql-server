--source include/have_router.inc
--source include/have_jit_executor.inc

--source ../include/mrs/is_mrs_schema_v4.inc

# Set the router-id, to generate statistics
# this way we can wait until router detects
# changes.
--let $extra_mrs_router_id=1
--source ../include/predefined_setup/configure_router_mrs_root.inc
--source ../include/schema/basic_schema.sql

CREATE USER user1@'%' IDENTIFIED BY 'secretpass1';

--source ../include/mrs/start_object_definition.inc

# Roles
--let $mrs_add_role_caption=AllPriv
--source ../include/mrs/role/add.inc

--let $mrs_grant_privilege_service_path=/svc1
--let $mrs_grant_privilege_schema_path=*
--let $mrs_grant_privilege_object_path=*
--let $mrs_grant_privilege_crud_operations=READ,CREATE,UPDATE,DELETE
--source ../include/mrs/role/grant_privilege.inc

# Service
--let $mrs_add_service_path="/svc1"
--let $mrs_add_host_name=""
--source ../include/mrs/service/add.inc

# A schema is needed to create the db_object
--let $mrs_add_schema=basic_schema
--let $mrs_add_schema_path=/basic_schema
--source ../include/mrs/db_schema/add.inc


# Auth
--let $mrs_add_auth_app=default authentication
--let $mrs_add_auth_vendor=MySQL Internal
--let $mrs_add_auth_service=/svc1
--source ../include/mrs/auth_app/add.inc

# Users
--let $mrs_add_user_ext_uid='user1@%'
--let $mrs_add_user_name='user1'
--let $mrs_add_user_role=AllPriv
--let $mrs_add_user_auth_string='ignore'
--source ../include/mrs/user/add.inc

# Content Set
--let $mrs_add_content_set_path=/set
--let $mrs_add_content_set_enabled=1
--let $mrs_add_content_set_options='{"script_module_files":[{"class_name":"Types","file_to_load":"/Types.js"}],"contains_mrs_scripts":true}'
--let $mrs_add_content_set_content_type='SCRIPTS'
--source ../include/mrs/content_set/add.inc
SET @my_set=@content_set_id;

# Content files
--let $mrs_add_content_file_path=/Types.js
let $mrs_add_content="let Types = (() => {
  let _classThis; 
  (class {
    static { _classThis = this; }

    static returnValue(value) {
      return value;
    }

  }); return _classThis; })(); export { Types };";

--source ../include/mrs/content_file/add.inc
SET @auth_content_file_id=@content_file_id;


--let $default_script_file="/Types.js"
--let $default_script_class_name=Types


# returnValue
--let $script_function_name=returnValue
--let $mrs_add_object_fields=value
--let $mrs_add_object_field_types=VARCHAR(10)
--source scripting_add_endpoint.inc



--source ../include/mrs/end_object_definition.inc

## Test starts here
--echo
--echo  Calls a simple JavaScript function that returns 'Hello World!'
--echo  No authentication is needed for this one

--echo
--echo # String
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": "This will be returned!"}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # Booleans
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": true}'
--source ../include/mrs/mrs_client.inc

--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": "true"}'
--source ../include/mrs/mrs_client.inc

--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": false}'
--source ../include/mrs/mrs_client.inc

--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": "false"}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # Numbers
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": 1234}'
--source ../include/mrs/mrs_client.inc

--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": "1234"}'
--source ../include/mrs/mrs_client.inc

--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type='PUT'
--let $mrs_client_arg_payload='{"value": 123.45}'
--source ../include/mrs/mrs_client.inc

--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": "123.45"}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # -(2 ^ 53 - 1)
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": -9007199254740991}'
--source ../include/mrs/mrs_client.inc

--echo
--echo #  -(2 ^ 31) - 1
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": -2147483649}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # -(2 ^ 31)
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": -2147483648}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # (2 ^ 31) - 1
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": 2147483647}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # (2 ^ 31)
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": 2147483648}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # (2 ^ 53) - 1
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": 9007199254740991}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # Null
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": null}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # Array
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": ["sample", true, false, 1234, 12.34, null]}'
--source ../include/mrs/mrs_client.inc

--echo
--echo # Map
--let $mrs_client_arg_path='/svc1/basic_schema/returnValue'
--let $mrs_client_arg_request_type=PUT
--let $mrs_client_arg_payload='{"value": {"string": "sample", "true": true, "false": false, "integer": 1234, "float": 12.34, "null": null}}'
--source ../include/mrs/mrs_client.inc

# Cleanup
drop user user1@'%';

--source ../include/mrs/cleanup.inc
